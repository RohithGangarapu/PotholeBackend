# Pothole Detection System - Visual Flow Diagrams

## 1. Complete System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              SYSTEM ARCHITECTURE                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

                              ┌───────────────────────┐
                              │   CLIENT / FRONTEND   │
                              │   (Mobile/Web App)    │
                              └───────────┬───────────┘
                                          │
                                          │ HTTPS/REST API
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│    ┌─────────────────────────────────────────────────────────────────────────┐    │
│    │                      DJANGO REST API SERVER                              │    │
│    │                        (localhost:8000)                                  │    │
│    │                                                                          │    │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐  │    │
│    │  │   Users     │  │   Devices   │  │  Potholes   │  │      Alerts     │  │    │
│    │  │  ViewSet    │  │  ViewSet    │  │  ViewSet    │  │    ViewSet      │  │    │
│    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘  │    │
│    │         │                │                │                  │            │    │
│    │         └────────────────┴────────────────┴──────────────────┘            │    │
│    │                                    │                                       │    │
│    │         ┌──────────────────────────┼──────────────────────────┐            │    │
│    │         │                          │                          │            │    │
│    │         ▼                          ▼                          ▼            │    │
│    │  ┌─────────────┐          ┌─────────────┐          ┌─────────────────┐   │    │
│    │  │   Video     │          │   Frame     │          │    Login        │   │    │
│    │  │   Stream    │          │  Processing │          │    View         │   │    │
│    │  │   View      │          │    Queue    │          │                 │   │    │
│    │  └─────────────┘          └─────────────┘          └─────────────────┘   │    │
│    │                                                                          │    │
│    └─────────────────────────────────────────────────────────────────────────┘    │
│                                      │                                             │
│                                      │                                             │
└──────────────────────────────────────┼─────────────────────────────────────────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼                                      ▼
        ┌─────────────────────┐              ┌─────────────────────────────┐
        │  VIDEO PROCESSOR    │              │      DATABASE               │
        │  (video_processor)  │              │   (PostgreSQL)              │
        │                     │              │                             │
        │  ┌───────────────┐  │              │  ┌───────┐ ┌───────┐       │
        │  │ VideoCapture  │  │              │  │ Users │ │Potholes│       │
        │  │ (OpenCV)      │  │              │  └───────┘ └───────┘       │
        │  └───────┬───────┘  │              │  ┌───────┐ ┌───────┐       │
        │          │          │              │  │Devices│ │ Alerts │       │
        │          ▼          │              │  └───────┘ └───────┘       │
        │  ┌───────────────┐  │              │                             │
        │  │ Capture Thread│  │              │                             │
        │  │ (Background)  │  │              │                             │
        │  └───────┬───────┘  │              │                             │
        │          │          │              │                             │
        └──────────┼──────────┘              └─────────────────────────────┘
                   │
                   │ Send frame
                   │
                   ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │                    DETECTION PIPELINE                               │
    │                                                                     │
    │   ┌──────────┐     ┌──────────┐     ┌──────────────┐               │
    │   │  Frame   │────►│  Temp    │────►│   Pothole    │               │
    │   │  Buffer  │     │ Storage  │     │  Detector    │               │
    │   └──────────┘     └──────────┘     │  (HTTP API)  │               │
    │                                        └──────┬───────┘               │
    │                                               │                       │
    │                                               ▼                       │
    │   ┌─────────────────────────────────────────────────────────────┐    │
    │   │          HUGGING FACE SPACES (External)                     │    │
    │   │                                                             │    │
    │   │   RohithGangarapu/PotholeYoloV8-NEW                         │    │
    │   │   ┌─────────────────────────────────────────────────────┐   │    │
    │   │   │                  YOLOv8 Model                       │   │    │
    │   │   │                                                     │   │    │
    │   │   │   Input: Image     Output: Bounding Boxes          │   │    │
    │   │   │   ──────────────   ─────────────────────────────   │   │    │
    │   │   │   • Road image    • [x1, y1, x2, y2, conf, cls]   │   │    │
    │   │   │                    • Pothole detection             │   │    │
    │   │   └─────────────────────────────────────────────────────┘   │    │
    │   │                                                             │    │
    │   └─────────────────────────────────────────────────────────────┘    │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
```

---

## 2. Video Streaming Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            VIDEO STREAMING FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

    TIME ──────────────────────────────────────────────────────────────────────────►

    ┌─────────────┐     ┌───────────────────────┐     ┌───────────────────────────┐
    │   START     │     │  VIDEO STREAM SETUP   │     │  FRAME CAPTURE LOOP       │
    │   USER      │     │  ──────────────────   │     │  ─────────────────────    │
    └──────┬──────┘     └───────────┬───────────┘     └───────────┬───────────────┘
           │                        │                             │
           │ POST /video-stream/    │                             │
           │ {stream_id,            │                             │
           │  video_url,            │                             │
           │  frame_interval}       │                             │
           └───────────────────────►│                             │
                                    │                             │
                                    ▼                             │
                         ┌─────────────────────┐                 │
                         │ VideoCapture.open() │                 │
                         │ (OpenCV)            │                 │
                         └──────────┬──────────┘                 │
                                    │                            │
                                    │ [Connection Established]   │
                                    │                            │
                                    ▼                            │
                         ┌─────────────────────┐                 │
                         │ Start Thread        │────────────────►│ [Background Process]
                         │ _capture_frames()   │                 │
                         └──────────┬──────────┘                 │
                                    │                            │
                                    │ [Loop: while is_running]   │
                                    │                            │
                                    │        ┌──────────────────┴──────────┐
                                    │        │                                  │
                                    │        │                                  ▼
                                    │        │                    ┌─────────────────────┐
                                    │        │                    │ cv2.cap.read()      │
                                    │        │                    │ Get new frame       │
                                    │        │                    └──────────┬──────────┘
                                    │        │                               │
                                    │        │                               ▼
                                    │        │                    ┌─────────────────────┐
                                    │        │                    │ Check time elapsed  │
                                    │        │                    │ since last capture  │
                                    │        │                    └──────────┬──────────┘
                                    │        │                               │
                                    │        │              ┌────────────────┴────────────┐
                                    │        │              │                              │
                                    │        │    YES (≥frame_interval)   │              NO
                                    │        │              │                              │
                                    │        │              ▼                              │
                                    │        │    ┌─────────────────────┐                  │
                                    │        │    │ _send_frame_to_     │                  │
                                    │        │    │ detection(frame)    │                  │
                                    │        │    └──────────┬──────────┘                  │
                                    │        │               │                             │
                                    │        │               ▼                             │
                                    │        │    ┌─────────────────────┐                  │
                                    │        │    │ POST /potholes/     │                  │
                                    │        │    │ upload-image/       │                  │
                                    │        │    └──────────┬──────────┘                  │
                                    │        │               │                             │
                                    │        │               ▼                             │
                                    │        │    ┌─────────────────────┐                  │
                                    │        │    │  Process Response   │                  │
                                    │        │    │  (Create Pothole)   │                  │
                                    │        │    └─────────────────────┘                  │
                                    │        │                                                  │
                                    │        │    [Repeat loop]                               │
                                    │        │                                                  │
                                    │        └──────────────────────────────────────────────────┘
                                    │
                                    │ DELETE /video-stream/{id}/
                                    │
                                    ▼
                         ┌─────────────────────┐
                         │ Stop Thread         │
                         │ Release Resources   │
                         └─────────────────────┘
```

---

## 3. Detection Request/Response Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          DETECTION REQUEST FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐         ┌───────────┐         ┌───────────┐         ┌───────────┐
    │   Django    │         │  Temp     │         │  HF API   │         │  Hugging  │
    │   Server    │         │  Storage  │         │  Client   │         │   Space   │
    └──────┬──────┘         └─────┬─────┘         └─────┬─────┘         └─────┬─────┘
           │                      │                     │                      │
           │ 1. Save frame        │                     │                      │
           │    to temp file      │                     │                      │
           ├─────────────────────►│                     │                      │
           │                      │                     │                      │
           │                      │                     │                      │
           │                      │                     │                      │
           │ 2. POST /upload      │                     │                      │
           │    (multipart)       │                     │                      │
           ├──────────────────────┼────────────────────►│                      │
           │                      │                     │                      │
           │                      │                     │ 3. Upload file       │
           │                      │                     │    to Space          │
           │                      │                     ├─────────────────────►│
           │                      │                     │                      │
           │                      │                     │                      │
           │                      │                     │ 4. Return remote     │
           │                      │                     │    file path         │
           │                      │                     ◄─────────────────────┤
           │                      │                     │                      │
           │                      │                     │                      │
           │ 5. POST /call/predict│                     │                      │
           │    {data: [path]}    │                     │                      │
           ├──────────────────────┼────────────────────►│                      │
           │                      │                     │                      │
           │                      │                     │ 6. Create task       │
           │                      │                     │    Return event_id   │
           │                      │                     ◄─────────────────────┤
           │                      │                     │                      │
           │                      │                     │                      │
           │                      │                     │ 7. GET /call/predict/│
           │                      │                     │    {event_id}        │
           │                      │                     │    (SSE stream)      │
           │                      │                     ├─────────────────────►│
           │                      │                     │                      │
           │                      │                     │                      │
           │                      │                     │ 8. Stream events:    │
           │                      │                     │    - event: complete │
           │                      │                     │    - data: [...]     │
           │                      │                     │    - event: complete │
           │                      │                     │    - data: [img,detections] │
           │                      │                     ◄─────────────────────┤
           │                      │                     │                      │
           │                      │                     │                      │
           │ 9. Parse detections  │                     │                      │
           │    (bboxes, depth,   │                     │                      │
           │     severity)        │                     │                      │
           │                      │                     │                      │
           ▼                      ▼                     ▼                      ▼
```

---

## 4. Data Model Relations

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           DATABASE RELATIONS                                        │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐                    ┌─────────────────┐
    │      USER       │                    │    IOTDEVICE    │
    ├─────────────────┤                    ├─────────────────┤
    │ id              │                    │ id              │
    │ email           │                    │ device_id       │
    │ password        │                    │ name            │
    │ name            │◄───────────────────│ status          │
    │ created_at      │    (owner_id)      │ location        │
    └─────────────────┘                    │ owner_id        │
                                            └────────┬────────┘
                                                     │
                                                     │ (detects)
                                                     ▼
    ┌─────────────────┐                    ┌─────────────────┐
    │     ALERT       │                    │    POTHOLE      │
    ├─────────────────┤                    ├─────────────────┤
    │ id              │                    │ id              │
    │ alert_type      │                    │ depth           │
    │ message         │                    │ severity        │
    │ is_read         │                    │ image           │
    │ user_id         │◄──┐                │ latitude        │
    │ pothole_id      │◄──┤                │ longitude       │
    └─────────────────┘   │                │ device_id       │──┐
                         │                │ user_id         │  │
                         │                │ status          │  │
                         │                │ created_at      │  │
                         │                └─────────────────┘  │
                         │                                    │
                         │ (triggers)                        │ (triggers)
                         │                                    │
                         ▼                                    ▼
                    ┌─────────────────┐               ┌─────────────────┐
                    │    NOTIFICATION │               │   REPAIR TEAM   │
                    ├─────────────────┤               ├─────────────────┤
                    │ id              │               │ id              │
                    │ type            │               │ name            │
                    │ recipient       │               │ assigned_to     │
                    │ status          │               │ phone           │
                    └─────────────────┘               └─────────────────┘
```

---

## 5. Frame Processing Queue

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        FRAME QUEUE PROCESSING                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌───────────────────┐
                                    │  TASK QUEUE       │
                                    │  (Priority Queue) │
                                    ├───────────────────┤
                                    │                   │
                                    │  ┌───┐ ┌───┐ ┌───┐│
                                    │  │T1 │ │T2 │ │T3 ││
                                    │  └───┘ └───┘ └───┘│
                                    │    ↑        ↑     │
                                    │    │        │     │
                                    │    └────────┘     │
                                    │                   │
                                    └───────────────────┘
                                              │
                                              │ queue.get()
                                              ▼
                              ┌───────────────────────────────┐
                              │         WORKER THREADS        │
                              │                               │
           ┌──────────────────┼───────────────┬───────────────┼──────────────────┐
           │                  │               │               │                  │
           ▼                  ▼               ▼               ▼                  ▼
    ┌─────────────┐   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   ┌─────────────┐
    │  Worker 1   │   │  Worker 2   │ │  Worker 3   │ │  Worker 4   │   │  Worker N   │
    │             │   │             │ │             │ │             │   │             │
    │ Task: T1    │   │ Task: T2    │ │ Task: ...   │ │ Task: ...   │   │ Task: ...   │
    │ Status: RUN │   │ Status: RUN │ │ Status: IDLE│ │ Status: IDLE│   │ Status: IDLE│
    │             │   │             │ │             │ │             │   │             │
    └─────────────┘   └─────────────┘ └─────────────┘ └─────────────┘   └─────────────┘
           │                  │               │               │                  │
           └──────────────────┴───────────────┴───────────────┴──────────────────┘
                                              │
                                              │ queue.task_done()
                                              ▼
                                    ┌───────────────────┐
                                    │   RESULT STORE    │
                                    ├───────────────────┤
                                    │                   │
                                    │  T1: COMPLETED    │
                                    │  T2: COMPLETED    │
                                    │  T3: FAILED       │
                                    │  T4: PENDING      │
                                    │                   │
                                    └───────────────────┘
```

---

## 6. Severity Classification Algorithm

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                       SEVERITY CLASSIFICATION                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────────┐
                    │          DETECTION RESULT               │
                    │  Bounding Box: [x1, y1, x2, y2]        │
                    │  Confidence: 0.87                       │
                    │  Class: Pothole                         │
                    └──────────────────┬──────────────────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼                                      ▼
           ┌─────────────────┐                ┌─────────────────────────┐
           │ Calculate Area  │                │ Image Dimensions        │
           │                 │                │                         │
           │ width = x2-x1   │                │ img_height = 1080       │
           │ height = y2-y1  │                │ img_width = 1920        │
           │ area = w*h      │                │ total_area = h*w        │
           └────────┬────────┘                └─────────────────────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Calculate       │
           │ Relative Area   │
           │                 │
           │ rel_area =      │
           │   area /        │
           │   total_area    │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Calculate Depth │
           │                 │
           │ depth =         │
           │   rel_area *    │
           │   50            │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Classify        │
           │                 │
           │ if depth > 15:  │─────────────► HIGH SEVERITY
           │   severity=     │              Color: RED (0,0,255)
           │   "high"        │              Priority: CRITICAL
           │ elif depth > 5: │              ──────────────────────
           │   severity=     │              Action: Immediate
           │   "medium"      │              repair required
           │ else:           │
           │   severity=     │
           │   "low"         │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Visual Output   │
           │                 │
           │ Draw rectangle  │
           │ with color      │
           │ based on        │
           │ severity        │
           └─────────────────┘
```

---

## 7. Complete Request/Response Cycle

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                       COMPLETE REQUEST/RESPONSE CYCLE                               │
└─────────────────────────────────────────────────────────────────────────────────────┘

    CLIENT                    DJANGO                  DETECTOR                   DB
      │                         │                        │                       │
      │  POST /video-stream/    │                        │                       │
      │  {stream_id, video_url}│                        │                       │
      ├────────────────────────►│                        │                       │
      │                         │                        │                       │
      │                         │  VideoStreamProcessor  │                       │
      │                         │  .start_streaming()    │                       │
      │                         │                        │                       │
      │  {"status":"success"}   │                        │                       │
      ◄─────────────────────────┤                        │                       │
      │                         │                        │                       │
      │                         │  [Background Thread]   │                       │
      │                         │  ────────────────────►│                       │
      │                         │                        │                       │
      │                         │                        │  POST /upload         │
      │                         │                        │  (frame.jpg)          │
      │                         │                        ├──────────────────────►│
      │                         │                        │                       │
      │                         │                        │  POST /predict        │
      │                         │                        ├──────────────────────►│
      │                         │                        │                       │
      │                         │                        │  GET /predict/{id}    │
      │                         │                        │  (SSE stream)         │
      │                         │                        ├──────────────────────►│
      │                         │                        │                       │
      │                         │                        │  Return detections    │
      │                         │  detections, image     │                       │
      │                         │◄───────────────────────┤                       │
      │                         │                        │                       │
      │                         │  Pothole.objects.create()                      │
      │                         │  (depth, severity,     │                       │
      │                         │   image, coords)       │                       │
      │                         │────────────────────────┼──────────────────────►│
      │                         │                        │                       │
      │  GET /potholes/         │                        │                       │
      ├────────────────────────►│                        │                       │
      │                         │                        │                       │
      │                         │  Serialize objects     │                       │
      │                         │                        │                       │
      │  [{pothole1}, {pothole2}]                         │                       │
      ◄─────────────────────────┤                        │                       │
      │                         │                        │                       │
      │  DELETE /video-stream/  │                        │                       │
      │  {stream_id}            │                        │                       │
      ├────────────────────────►│                        │                       │
      │                         │                        │                       │
      │                         │  processor.stop()      │                       │
      │                         │                        │                       │
      │  {"status":"success"}   │                        │                       │
      ◄─────────────────────────┤                        │                       │
```

---

## 8. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            ERROR HANDLING FLOW                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────────────────────────────────────┐
    │                           ERROR SCENARIOS                                    │
    ├─────────────────────────────────────────────────────────────────────────────┤
    │                                                                             │
    │  ┌─────────────┐                                                           │
    │  │   ERROR     │  ─────────────►  HANDLING                                  │
    │  │  SCENARIO   │                   FLOW                                     │
    │  └─────────────┘                                                           │
    │                                                                             │
    │  ─────────────────────────────────────────────────────────────────────────  │
    │                                                                             │
    │  Video URL Invalid                                                          │
    │  ──────────────────                                                         │
    │       │                                                                     │
    │       ▼                                                                     │
    │  ┌─────────────────────┐                                                    │
    │  │ cap.isOpened()      │                                                    │
    │  │ returns False       │                                                    │
    │  └──────────┬──────────┘                                                    │
    │             │                                                               │
    │             ▼                                                               │
    │  ┌─────────────────────┐                                                    │
    │  │ Log error           │                                                    │
    │  │ "Failed to open     │                                                    │
    │  │  video stream"      │                                                    │
    │  └──────────┬──────────┘                                                    │
    │             │                                                               │
    │             ▼                                                               │
    │  ┌─────────────────────┐                                                    │
    │  │ Return 400 Bad      │                                                    │
    │  │ Request to client   │                                                    │
    │  └─────────────────────┘                                                    │
    │                                                                             │
    │  ─────────────────────────────────────────────────────────────────────────  │
    │                                                                             │
    │  Detection API Timeout                                                     │
    │  ────────────────────                                                       │
    │       │                                                                     │
    │       ▼                                                                     │
    │  ┌─────────────────────┐                                                    │
    │  │ requests.post()     │                                                    │
    │  │ timeout exceeded    │                                                    │
    │  └──────────┬──────────┘                                                    │
    │             │                                                               │
    │             ▼                                                               │
    │  ┌─────────────────────┐                                                    │
    │  │ Increment           │                                                    │
    │  │ frames_failed       │                                                    │
    │  └──────────┬──────────┘                                                    │
    │             │                                                               │
    │             ▼                                                               │
    │  ┌─────────────────────┐                                                    │
    │  │ Log error           │                                                    │
    │  │ Continue loop       │                                                    │
    │  └─────────────────────┘                                                    │
    │                                                                             │
    │  ─────────────────────────────────────────────────────────────────────────  │
    │                                                                             │
    │  Database Error                                                             │
    │  ───────────────                                                            │
    │       │                                                                     │
    │       ▼                                                                     │
    │  ┌─────────────────────┐                                                    │
    │  │ Pothole.objects.    │                                                    │
    │  │ create() fails      │                                                    │
    │  └──────────┬──────────┘                                                    │
    │             │                                                               │
    │             ▼                                                               │
    │  ┌─────────────────────┐                                                    │
    │  │ Return 500 Server   │                                                    │
    │  │ Error response      │                                                    │
    │  └─────────────────────┘                                                    │
    │                                                                             │
    └─────────────────────────────────────────────────────────────────────────────┘
```

---

*Diagrams generated for Pothole Detection System*

